# vim: filetype=zsh

function mount_share() {
    if [[ $1 == "-h" ]]; then
        echo "Usage: mount_network_share -s [server] -r [share] -u [username] -d [domain] -p [protocol]"
        echo "Mounts a network share at the specified server."
        echo "Options:"
        echo "  -s    Specifies the server to connect to."
        echo "  -r    Specifies the remote share to mount."
        echo "  -u    Specifies the username (default is current session's username)."
        echo "  -d    Specifies the domain (optional)."
        echo "  -p    Specifies the protocol (default is samba, can also be nfs)."
        return
    fi

    local OPTIND opt server share username domain protocol
    while getopts "s:r:u:d:p:" opt; do
      case $opt in
        s) server="$OPTARG" ;;
        r) share="$OPTARG" ;;
        u) username="$OPTARG" ;;
        d) domain="$OPTARG" ;;
        p) protocol="$OPTARG" ;;
      esac
    done

    username=${username:-$USER}
    protocol=${protocol:-cifs}

    if [[ -n $server && -n $share ]]; then
        # Create a mount point named as "server_share"
        local mount_point_host="${HOME}/mnt/${server}"
        local mount_point_ro="${HOME}/mnt/${server}/.${server}_${share}"
        local mount_point_rw="${HOME}/mnt/${server}/${server}_${share}"
        mkdir -p "${mount_point_host}" 
        mkdir -p "${mount_point_ro}" 
        mkdir -p "${mount_point_rw}" 
        
        if [[ $protocol == "samba" || $protocol == "cifs" ]]; then
            if [[ -n $domain ]]; then
                sudo mount.cifs "//$server/$share" "${mount_point_ro}" -o user=$username,dom=$domain
            else
                sudo mount.cifs "//$server/$share" "${mount_point_ro}" -o user=$username
            fi
            sudo bindfs --map=root/$(whoami) "${mount_point_ro}" "${mount_point_rw}"
        elif [[ $protocol == "nfs" ]]; then
            sudo mount -t nfs "${server}:${share}" "${mount_point_rw}"
        fi

        if [[ $? -ne 0 ]]; then
          rmdir  "${mount_point_rw}"
          rmdir  "${mount_point_ro}"
          if [ $(ls -1A ${mount_point_host} | wc -l) -eq 0 ]; then
             rmdir  "${mount_point_host}" 
          fi
        fi
    else
        echo "Usage: mount_network_share -s [server] -r [share] -u [username] -d [domain] -p [protocol]"
    fi
}
