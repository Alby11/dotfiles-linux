# vim: filetype=zsh
pwssh_session() {
  if [[ $# -ne 2 ]]; then
    echo "Usage: pwssh_session <user> <remoteServer>"
    return 1
  fi

  local credentialUser="$1"
  local remoteServer="$2"

  # Use SSH to connect and start a PowerShell session on the remote server
  # Escape PowerShell command more carefully
    credentialUser=$credentialUser \
      remoteServer=$remoteServer \
      pwsh -NoExit -Command '
        $credential = $(Get-Credential -UserName $env:credentialUser -Message "Enter your password")
        $session = New-PSSession -Credential $credential -ComputerName $env:remoteServer
        Invoke-Command -Session $session -ScriptBlock {
          param(
          $credential
          )
          Set-Variable -Name "credential" -Value $credential
          pwsh -NoExit
        } -ArgumentList $credential
        Enter-PSSession -Session $session
        '
}
