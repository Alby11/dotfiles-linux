# vim: filetype=zsh

### SSH AGENT BLOCK
# LOAD SSH AFTER EACH REBOOT (RE-USES SAME SSH-AGENT INSTANCE)

# Check for keychain and install if missing
if ! CHECK_COMMANDS keychain; then
    echo "keychain not found. Attempting to install..."
    # Adjust the installation command below according to your system's package manager
    package_manager_install keychain || { echo "Failed to install keychain. Exiting."; exit 1; }
fi

export SSH_ENV="${HOME}/.ssh/agent-environment"

start_agent() {
    echo "Initialising new SSH agent..."
    /usr/bin/ssh-agent | sed 's/^echo/#echo/' > "${SSH_ENV}"
    echo succeeded
    chmod 600 "${SSH_ENV}"
    . "${SSH_ENV}" > /dev/null

    # Use keychain for SSH key management
    /usr/bin/keychain --quiet --eval --agents ssh $(find ${HOME}/.ssh -type f -name 'id_*' ! -name '*.pub' -printf '%f\n')
    if [[ $? -eq 0 ]]; then
        echo "SSH keys added successfully."
    else
        echo "Failed to add SSH keys."
    fi
}

# Source SSH settings, if applicable
if [[ -f "${SSH_ENV}" ]]; then
    . "${SSH_ENV}" > /dev/null
    # Check if the SSH agent is running. If not, start a new agent.
    if ! ps -p ${SSH_AGENT_PID} > /dev/null 2>&1; then
        start_agent;
    fi
else
    start_agent;
fi

# Clean up the function from the environment
unset -f start_agent
### END OF SSH BLOCK

